{% extends "base.html" %}

{% block title %}SQL for Testers - Aprende SQL en Tiempo Real{% endblock %}

{% block extra_css %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
<style>
    .CodeMirror {
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 0.375rem;
        font-family: 'Fira Code', monospace;
    }

    .hero {
        margin-top: 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero text-center py-5 bg-light mb-5 rounded-3">
    <div class="container">
        <h1 class="display-4 fw-bold text-primary">Aprende SQL para Testing</h1>
        <p class="lead text-muted mb-4">Practica SQL en tiempo real con ejercicios interactivos y feedback inmediato</p>
        <div class="d-flex justify-content-center gap-3">
            <a href="/exercise/1" class="btn btn-primary btn-lg px-4">Comenzar a Practicar</a>
            <a href="/lesson/1" class="btn btn-outline-secondary btn-lg px-4">Explorar Lecciones</a>
        </div>
    </div>
</section>

<!-- Categorías -->
<section class="categories mb-5">
    <div class="container">
        <h2 class="text-center mb-4"><i class="fas fa-th-large me-2 text-primary"></i>Categorías de Aprendizaje SQL</h2>
        <div class="row row-cols-1 row-cols-md-3 g-4">
            {% for category in categoryData %}
            <div class="col">
                <a href="/category/{{ category.id }}" class="text-decoration-none">
                    <div class="card h-100 shadow-sm hover-card text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-code fa-3x text-primary mb-3"></i>
                            <h3 class="h4 text-dark">{{ category.name }}</h3>
                            <p class="text-muted">{{ category.description }}</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- SQL Editor Section -->
<section class="sql-editor mb-5" id="sqlEditor">
    <div class="container">
        <h2 class="text-center mb-4"><i class="fas fa-code me-2 text-dark"></i>Practica SQL en Tiempo Real</h2>
        <div class="card shadow-lg">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center p-3">
                <span class="fw-bold">Editor SQL</span>
                <div class="btn-group">
                    <button class="btn btn-success btn-sm" id="executeQuery"><i class="fas fa-play me-1"></i>
                        Ejecutar</button>
                    <button class="btn btn-secondary btn-sm" id="resetQuery"><i class="fas fa-redo me-1"></i>
                        Reiniciar</button>
                    <button class="btn btn-info btn-sm text-white" id="showHelp"><i
                            class="fas fa-question-circle me-1"></i> Ayuda</button>
                </div>
            </div>
            <div class="card-body p-0">
                <textarea id="sqlEditorTextArea">SELECT * FROM employees;</textarea>
            </div>
            <div class="card-footer bg-light">
                <h5 class="mb-3">Resultados</h5>
                <div class="table-responsive">
                    <table id="resultsTable" class="table table-striped table-hover table-bordered bg-white mb-0">
                        <thead class="table-dark">
                            <tr></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/sql-hint.min.js"></script>
<script>
    // Inicializar CodeMirror
    const editor = CodeMirror.fromTextArea(document.getElementById('sqlEditorTextArea'), {
        mode: 'text/x-sql',
        theme: 'default',
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        lineWrapping: true,
        matchBrackets: true,
        autofocus: false,
        extraKeys: { "Ctrl-Space": "autocomplete" },
        hintOptions: {
            tables: {
                employees: ["employee_id", "first_name", "last_name", "email", "department_id", "salary", "hire_date"],
                departments: ["department_id", "department_name", "location"],
                projects: ["project_id", "project_name", "description", "start_date", "end_date", "budget"],
                bugs: ["bug_id", "bug_title", "severity", "status", "reported_by", "assigned_to"],
                test_results: ["test_id", "test_name", "test_status", "tester_id", "project_id"]
            }
        }
    });

    // Función para ejecutar la consulta
    document.getElementById('executeQuery').addEventListener('click', async () => {
        const query = editor.getValue();
        const resultsTable = document.getElementById('resultsTable');
        const thead = resultsTable.querySelector('thead tr');
        const tbody = resultsTable.querySelector('tbody');

        try {
            const response = await fetch('/execute-sql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });

            if (response.status === 401) {
                alert('Debes iniciar sesión para ejecutar consultas.');
                window.location.href = '/loginForm';
                return;
            }

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // Limpiar la tabla
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Agregar encabezados
            data.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                thead.appendChild(th);
            });

            // Agregar filas
            data.results.forEach(row => {
                const tr = document.createElement('tr');
                data.columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = row[column] !== null ? row[column] : 'NULL';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

        } catch (error) {
            alert('Error: ' + error.message);
        }
    });

    // Función para reiniciar el editor
    document.getElementById('resetQuery').addEventListener('click', () => {
        editor.setValue('SELECT * FROM employees;');
        editor.focus();
    });

    // Función para mostrar ayuda
    document.getElementById('showHelp').addEventListener('click', () => {
        alert('Ejemplos de consultas:\\n\\n' +
            'SELECT * FROM employees;\\n' +
            'SELECT first_name, last_name FROM employees WHERE department_id = 2;\\n' +
            'SELECT * FROM bugs WHERE severity = \\'Critical\\';\\n' +
            'SELECT e.first_name, d.department_name FROM employees e JOIN departments d ON e.department_id = d.department_id;\\n\\n' +
            'Sugerencias:\\n' +
            '- Usa Ctrl+Space para autocompletar\\n' +
            '- Las consultas deben terminar con punto y coma (;)\\n' +
        '- Debes estar autenticado para ejecutar consultas');
    });
</script>
{% endblock %}