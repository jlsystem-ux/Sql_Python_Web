{% extends "base.html" %}

{% block title %}{{ exercise.title }} - SQL for Testers{% endblock %}

{% block extra_css %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<style>
    .exercise-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        /* Use min-height instead of fixed height to avoid footer overlap */
        min-height: 70vh;
        margin-bottom: 2rem;
    }

    .instruction-panel {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
    }

    .editor-panel {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .CodeMirror {
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: 'Fira Code', monospace;
        font-size: 14px;
    }

    .results-panel {
        flex-grow: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        overflow: auto;
        display: flex;
        flex-direction: column;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .results-table th,
    .results-table td {
        padding: 0.5rem;
        border: 1px solid #eee;
        text-align: left;
        font-size: 0.9rem;
    }

    .results-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .feedback-message {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        display: none;
    }

    .feedback-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .feedback-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .schema-info {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }

    .schema-table {
        font-size: 0.85rem;
        color: #666;
    }

    @media (max-width: 992px) {
        .exercise-container {
            grid-template-columns: 1fr;
            height: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="exercise-container">
        <!-- Left Panel: Instructions -->
        <div class="instruction-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h3 mb-0">{{ exercise.title }}</h1>
                <span class="badge bg-info">{{ exercise.difficulty }}</span>
            </div>

            <div class="mb-4">
                <h5 class="text-muted mb-2">Instrucciones</h5>
                <p class="lead">{{ exercise.description }}</p>
            </div>

            {% if exercise.hint %}
            <div class="alert alert-warning">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>Pista:</strong> {{ exercise.hint }}
            </div>
            {% endif %}

            <div class="schema-info">
                <h5 class="text-muted mb-2">Esquema de Base de Datos</h5>
                <div class="accordion" id="schemaAccordion">
                    <!-- Employees -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingEmployees">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseEmployees">
                                <i class="fas fa-users me-2"></i> employees
                            </button>
                        </h2>
                        <div id="collapseEmployees" class="accordion-collapse collapse"
                            data-bs-parent="#schemaAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush schema-table">
                                    <li class="list-group-item">employee_id (PK)</li>
                                    <li class="list-group-item">first_name</li>
                                    <li class="list-group-item">last_name</li>
                                    <li class="list-group-item">email</li>
                                    <li class="list-group-item">department_id (FK)</li>
                                    <li class="list-group-item">salary</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- Departments -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingDepartments">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseDepartments">
                                <i class="fas fa-building me-2"></i> departments
                            </button>
                        </h2>
                        <div id="collapseDepartments" class="accordion-collapse collapse"
                            data-bs-parent="#schemaAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush schema-table">
                                    <li class="list-group-item">department_id (PK)</li>
                                    <li class="list-group-item">department_name</li>
                                    <li class="list-group-item">location</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- Bugs -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingBugs">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseBugs">
                                <i class="fas fa-bug me-2"></i> bugs
                            </button>
                        </h2>
                        <div id="collapseBugs" class="accordion-collapse collapse" data-bs-parent="#schemaAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush schema-table">
                                    <li class="list-group-item">bug_id (PK)</li>
                                    <li class="list-group-item">bug_title</li>
                                    <li class="list-group-item">severity</li>
                                    <li class="list-group-item">status</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Editor & Results -->
        <div class="editor-panel">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-code me-2"></i>Editor SQL</span>
                    <div class="btn-group">
                        <button class="btn btn-secondary btn-sm" id="resetBtn"><i class="fas fa-undo me-1"></i>
                            Reiniciar</button>
                        <button class="btn btn-info btn-sm" id="runBtn"><i class="fas fa-play me-1"></i>
                            Ejecutar</button>
                        <button class="btn btn-success btn-sm" id="submitBtn"><i class="fas fa-check me-1"></i> Enviar
                            Respuesta</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <textarea id="sqlEditor">SELECT * FROM employees;</textarea>
                </div>
            </div>

            <div class="results-panel">
                <h5 class="border-bottom pb-2 mb-3">Resultados</h5>

                <div id="feedbackMessage" class="feedback-message"></div>

                <div class="table-responsive">
                    <table id="resultsTable" class="results-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/sql-hint.min.js"></script>
<script>
    // Initialize CodeMirror
    const editor = CodeMirror.fromTextArea(document.getElementById('sqlEditor'), {
        mode: 'text/x-sql',
        theme: 'default',
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        lineWrapping: true,
        matchBrackets: true,
        extraKeys: { "Ctrl-Space": "autocomplete" },
        hintOptions: {
            tables: {
                employees: ["employee_id", "first_name", "last_name", "email", "department_id", "salary", "hire_date"],
                departments: ["department_id", "department_name", "location"],
                projects: ["project_id", "project_name", "status", "department_id"],
                bugs: ["bug_id", "bug_title", "severity", "status", "reported_by", "assigned_to"],
                test_results: ["test_id", "test_name", "test_status", "project_id"]
            }
        }
    });

    const exerciseId = {{ exercise_id }};
    const feedbackEl = document.getElementById('feedbackMessage');
    const tableHead = document.querySelector('#resultsTable thead');
    const tableBody = document.querySelector('#resultsTable tbody');

    // Helper to render table
    function renderTable(columns, rows) {
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        if (!columns || !rows) return;

        // Headers
        const headerRow = document.createElement('tr');
        columns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        // Rows
        rows.forEach(row => {
            const tr = document.createElement('tr');
            columns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] !== null ? row[col] : 'NULL';
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    // Run Code (Execute only)
    document.getElementById('runBtn').addEventListener('click', async () => {
        const query = editor.getValue();
        feedbackEl.style.display = 'none';

        try {
            const response = await fetch('/execute-sql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            if (response.status === 401) {
                window.location.href = '/loginForm';
                return;
            }

            const data = await response.json();

            if (data.error) {
                showFeedback(data.error, false);
                return;
            }

            renderTable(data.columns, data.results);
            showFeedback("Consulta ejecutada correctamente.", true);

        } catch (error) {
            showFeedback('Error de conexión: ' + error.message, false);
        }
    });

    // Submit Answer (Validate)
    document.getElementById('submitBtn').addEventListener('click', async () => {
        const query = editor.getValue();

        // Reset UI
        feedbackEl.style.display = 'none';
        feedbackEl.className = 'feedback-message';
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        try {
            const response = await fetch('/validate-query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query, exerciseId: exerciseId })
            });

            if (response.status === 401) {
                window.location.href = '/loginForm';
                return;
            }

            const data = await response.json();

            if (data.error) {
                showFeedback(data.error, false);
                return;
            }

            // Show Feedback
            showFeedback(data.message, data.correct);

            // Render Results Table
            if (data.user_columns && data.user_results) {
                renderTable(data.user_columns, data.user_results);
            }

        } catch (error) {
            showFeedback('Error de conexión: ' + error.message, false);
        }
    });

    function showFeedback(message, isSuccess) {
        feedbackEl.textContent = message;
        feedbackEl.className = 'feedback-message ' + (isSuccess ? 'feedback-success' : 'feedback-error');
        feedbackEl.style.display = 'block';
    }

    document.getElementById('resetBtn').addEventListener('click', () => {
        editor.setValue('SELECT * FROM employees;');
        feedbackEl.style.display = 'none';
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
    });
</script>
{% endblock %}